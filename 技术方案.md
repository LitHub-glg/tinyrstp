# 基于LACP与BPDU协同探测的动态自愈无环网络方案

## 1. 方案概述

本方案针对4节点全互联网络中的广播风暴、故障引发的网络中断等问题，提出一种摒弃传统STP的动态自愈无环网络方案。通过LACP实现链路物理状态毫秒级探测，结合自定义BPDU完成设备存活与拓扑逻辑状态感知，实现快速收敛和故障自愈。

## 2. 设计目标

- **无环保证**：动态维持无环生成树，避免广播风暴
- **快速收敛**：故障检测与恢复时间 < 100ms
- **高可靠性**：支持单点/多点故障快速自愈
- **高效探测**：LACP+BPDU双层次协同探测机制

## 3. 系统架构

### 3.1 核心组件

| 组件 | 功能描述 |
|------|----------|
| 节点管理器 | 管理网络节点状态、端口信息 |
| LACP探测模块 | 链路物理状态毫秒级探测 |
| BPDU探测模块 | 设备存活与拓扑逻辑状态感知 |
| 拓扑控制器 | 动态生成/维护无环生成树 |
| 故障检测模块 | 综合链路和设备状态，判断故障 |
| 自愈执行模块 | 故障发生时快速重构生成树 |

### 3.2 网络拓扑

4节点全互联网络拓扑：
```
    Node1 ──── Node2
     │  ╲    ╱  │
     │   ╲  ╱   │
     │   ╱  ╲   │
     │  ╱    ╲  │
    Node3 ──── Node4
```

## 4. 核心技术

### 4.1 LACP链路探测机制

- **探测周期**：10ms
- **超时阈值**：30ms（3次探测失败）
- **探测内容**：链路连通性、带宽、延迟
- **状态定义**：UP/DOWN/DEGRADED

### 4.2 自定义BPDU协议

| 字段 | 长度 | 说明 |
|------|------|------|
| Protocol ID | 2B | 自定义协议标识 |
| Root ID | 8B | 根节点ID |
| Sender ID | 8B | 发送节点ID |
| Port ID | 2B | 发送端口ID |
| Cost | 4B | 路径开销 |
| Age | 4B | BPDU存活时间 |
| Max Age | 4B | 最大存活时间 |
| Hello Time | 4B | 发送周期 |
| Flags | 1B | 标志位（故障、拓扑变更等） |
| Checksum | 2B | 校验和 |

### 4.3 协同探测流程

1. **LACP层**：持续探测链路物理状态
2. **BPDU层**：周期性交换拓扑信息
3. **融合层**：综合两类信息，构建全局拓扑视图
4. **决策层**：基于拓扑视图计算最优生成树

### 4.4 无环生成树算法

采用改进的Prim算法，考虑：
- 链路带宽（优先选择高带宽链路）
- 链路延迟（优先选择低延迟链路）
- 链路稳定性（优先选择稳定链路）
- 节点负载（均衡节点负载）

## 5. 故障处理流程

### 5.1 故障检测

1. **链路故障**：LACP探测到3次连续失败
2. **节点故障**：BPDU超时（超过Max Age未收到）
3. **多点故障**：综合多个探测结果

### 5.2 自愈流程

```
故障检测 → 拓扑更新 → 生成树重计算 → 端口状态切换 → 流量恢复
    ↓           ↓            ↓              ↓             ↓
  <10ms      <20ms        <30ms          <20ms         <20ms
```

### 5.3 端口状态定义

| 状态 | 说明 |
|------|------|
| DISABLED | 端口禁用 |
| BLOCKING | 阻塞状态（不转发数据，接收BPDU） |
| LISTENING | 监听状态（不转发数据，发送/接收BPDU） |
| LEARNING | 学习状态（学习MAC地址，不转发数据） |
| FORWARDING | 转发状态（正常转发数据） |

## 6. 仿真实现方案

### 6.1 技术栈

- **编程语言**：Python 3.8+
- **可视化**：Matplotlib + NetworkX
- **异步处理**：asyncio
- **数据结构**：自定义拓扑类、节点类、链路类

### 6.2 模块划分

1. `node.py` - 节点类定义
2. `link.py` - 链路类定义
3. `lacp.py` - LACP探测模块
4. `bpdu.py` - BPDU协议模块
5. `topology.py` - 拓扑管理模块
6. `stp.py` - 生成树计算模块
7. `simulator.py` - 仿真主程序
8. `visualizer.py` - 可视化模块

### 6.3 仿真功能

- 4节点全互联网络初始化
- LACP/BPDU协同探测模拟
- 动态生成树维护
- 故障注入（链路/节点故障）
- 实时拓扑可视化
- 状态监控与日志记录
